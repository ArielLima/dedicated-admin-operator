apiVersion: v1
kind: Template
metadata:
  name: olm-artifacts-template
parameters:
- name: REGISTRY_IMG
  required: true
- name: CHANNEL
  value: staging
  required: true
- name: IMAGE_TAG
  value: latest
  required: true
objects:
- apiVersion: hive.openshift.io/v1alpha1
  kind: SelectorSyncSet
  metadata:
    generation: 1
    name: dedicated-admin-operator
  spec:
    clusterDeploymentSelector:
      matchLabels:
        api.openshift.com/managed: "true"
    resourceApplyMode: sync
    resources:
    - apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        labels:
          opsrc-datastore: "true"
          opsrc-provider: redhat
        name: dedicated-admin-operator-registry
        namespace: openshift-operator-lifecycle-manager
      spec:
        image: ${REGISTRY_IMG}:${CHANNEL}-${IMAGE_TAG}
        displayName: Dedicated Admin Operator
        icon:
          base64data: ""
          mediatype: ""
        publisher: Red Hat
        sourceType: grpc
    - apiVersion: v1
      kind: Namespace
      metadata:
        name: openshift-dedicated-admin
        annotations:
          openshift.io/node-selector: ""
        labels:
          openshift.io/cluster-monitoring: "true"
    - apiVersion: operators.coreos.com/v1alpha2
      kind: OperatorGroup
      metadata:
        name: dedicated-admin-operator
        namespace: openshift-dedicated-admin
      spec:
        targetNamespaces:
        - openshift-dedicated-admin
    - apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: dedicated-admin-operator
        namespace: openshift-dedicated-admin
      spec:
        channel: ${CHANNEL}
        name: dedicated-admin-operator
        source: dedicated-admin-operator-registry
        sourceNamespace: openshift-operator-lifecycle-manager
    - apiVersion: monitoring.coreos.com/v1
      kind: PrometheusRule
      metadata:
        labels:
          prometheus: sre-dedicated-admin-alerts
        name: sre-dedicated-admin-alerts
        namespace: openshift-monitoring
      spec:
        groups:
        - name: sre-dedicated-admin-alerts
          rules:
          - record: DedicatedAdminDesiredBlackList:count
            expr: |
              count(kube_namespace_created{namespace =~ "^(kube|openshift)-.*"}) + 
              count(kube_namespace_created{namespace =~ "^(logging|default|openshift|ops-health-monitoring|ops-project-operation-check|management-infra)$"})
          - alert: DedicatedAdminBlackListMismatch5Min
            expr: "dedicated_admin_blacklisted_projects != DedicatedAdminDesiredBlackList:count"
            for: 5m
            annotations:
              message: "The number of projects blacklisted by dedicated-admin-operator does not match the expected regular expression"
            labels:
              severity: critical